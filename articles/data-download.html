<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using and downloading data • weda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using and downloading data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">weda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/camtrap-upload.html">Uploading camera trap records to database</a></li>
    <li><a class="dropdown-item" href="../articles/data-download.html">Using and downloading data</a></li>
    <li><a class="dropdown-item" href="../articles/database-connect.html">Connecting to the database</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JustinCally/weda/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using and downloading data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JustinCally/weda/blob/main/vignettes/data-download.Rmd" class="external-link"><code>vignettes/data-download.Rmd</code></a></small>
      <div class="d-none name"><code>data-download.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://justincally.github.io/weda/">weda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jniedballa/camtrapR" class="external-link">camtrapR</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="brief">Brief<a class="anchor" aria-label="anchor" href="#brief"></a>
</h2>
<p>Interacting with data on the ARI database can range from a
straightforward viewing and downloading through the shiny app, or more
complex and custom SQL queries. In this vignette we go through several
steps you can take to download and interact with data.</p>
</div>
<div class="section level2">
<h2 id="interacting-with-data-on-the-app">Interacting with data on the app<a class="anchor" aria-label="anchor" href="#interacting-with-data-on-the-app"></a>
</h2>
<p>The easiest way to interact with the database, and download/view
presence-absence data and VBA formatted data is by launching the
app.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make sure VPN is running</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">weda</span><span class="fu">::</span><span class="fu"><a href="../reference/weda_connect.html">weda_connect</a></span><span class="op">(</span>password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu">key_get</span><span class="op">(</span>service <span class="op">=</span> <span class="st">"ari-dev-weda-psql-01"</span>,</span>
<span>                                                      username <span class="op">=</span> <span class="st">"psql_user"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">weda</span><span class="fu">::</span><span class="fu"><a href="../reference/camtrap_app.html">camtrap_app</a></span><span class="op">(</span>con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span></code></pre></div>
<p>On the map pane you can download a presence-absence view of data for
a species, details about camera locations for a project/multiple
projects. You can also download a VBA formatted view of the data.</p>
</div>
<div class="section level2">
<h2 id="using-dbplyr-to-collect-data-in-r">Using <code>dbplyr</code> to collect data in R<a class="anchor" aria-label="anchor" href="#using-dbplyr-to-collect-data-in-r"></a>
</h2>
<p><code>dbplyr</code> is a database-specific implementation of the
commonly used and intuitive <code>dplyr</code> package. This means that
if you are familiar with <code>dplyr</code>/<code>tidyverse</code>
functions you should find it relatively straightforward to learn how to
pull down, <code>select</code>, <code>filter</code>, <code>join</code>
and <code>mutate</code> data. The main data we can pull down from the
<code>camtrap</code> schema are:</p>
<ul>
<li><code>curated_camtrap_operation</code></li>
<li>
<code>curated_camtrap_records</code><br>
</li>
<li>
<code>curated_project_information</code><br>
</li>
<li>
<code>processed_site_substation_presence_absence</code><br>
</li>
<li><code>processed_site_substation_daily_presence_absence</code></li>
</ul>
<div class="section level3">
<h3 id="lazy-views-of-the-data">Lazy views of the data<a class="anchor" aria-label="anchor" href="#lazy-views-of-the-data"></a>
</h3>
<p><code>dbplyr</code> allows for lazy evaluation of queries, meaning
that data will not be fully returned until a <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> is
called at the end of the code/query:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This doesn't return any data, just a dbplyr query to be evaluated</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html" class="external-link">in_schema</a></span><span class="op">(</span><span class="st">"camtrap"</span>, <span class="st">"curated_project_information"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># return the data with `collect()`</span></span>
<span><span class="va">project_data</span> <span class="op">&lt;-</span> <span class="va">query</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>In-between the initial query and the collection you can chuck in all
your dplyr filters, selects and mutates:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">project_data_filtered</span> <span class="op">&lt;-</span> <span class="va">query</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">DistanceSampling</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> <span class="va">AllSpeciesTagged</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ProjectName</span>, <span class="va">ProjectShortName</span>, <span class="va">DistanceSampling</span>, <span class="va">AllSpeciesTagged</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>StudyType <span class="op">=</span> <span class="st">"Distance Sampling"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="obtaining-camera-trap-records-and-operations-for-given-projects">Obtaining camera trap records and operations for given projects<a class="anchor" aria-label="anchor" href="#obtaining-camera-trap-records-and-operations-for-given-projects"></a>
</h3>
<p>Let’s say we want to do an analysis on Emus. We need to pull down the
emu records and the operation data for the cameras</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter for emus and projects that had distance sampling and all species tagged</span></span>
<span><span class="va">emu_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html" class="external-link">in_schema</a></span><span class="op">(</span><span class="st">"camtrap"</span>, <span class="st">"curated_camtrap_records"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">common_name</span> <span class="op">==</span> <span class="st">"Emu"</span> <span class="op">&amp;</span> <span class="va">ProjectShortName</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">!</span><span class="op">!</span><span class="va">project_data_filtered</span><span class="op">$</span><span class="va">ProjectShortName</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># operation tables </span></span>
<span><span class="va">emu_operations_query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html" class="external-link">in_schema</a></span><span class="op">(</span><span class="st">"camtrap"</span>, <span class="st">"curated_camtrap_operation"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ProjectShortName</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">!</span><span class="op">!</span><span class="va">project_data_filtered</span><span class="op">$</span><span class="va">ProjectShortName</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">emu_operations</span> <span class="op">&lt;-</span> <span class="va">emu_operations_query</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>With this raw data we can format it for distance sampling analysis or
other types of analyses. However, if you are just after data for
occupancy analysis there are some existing tools to help you.</p>
</div>
</div>
<div class="section level2">
<h2 id="presence-absence-data">Presence-absence data<a class="anchor" aria-label="anchor" href="#presence-absence-data"></a>
</h2>
<div class="section level3">
<h3 id="get-vba-data">Get VBA data<a class="anchor" aria-label="anchor" href="#get-vba-data"></a>
</h3>
<p>While the VBA format we will eventually use is still under
consideration this function (<code>vba_format</code>) will give you the
data from a project in the template of the VBA, this means you just need
to bulk upload it to VBA.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">VBA_statewide</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vba_format.html">vba_format</a></span><span class="op">(</span><span class="va">con</span>, ProjectShortName <span class="op">=</span> <span class="st">"StatewideDeer"</span>, return_data <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="presence-absence-tables">Presence-absence tables<a class="anchor" aria-label="anchor" href="#presence-absence-tables"></a>
</h3>
<p>Two presence-absence tables exist on the database. A presence-absence
for a given camera for the whole deployment and a daily
presence-absence.</p>
<p><em>Note: We define absence as the absence of any tagged images of a
species at a site, IF THAT SPECIES WAS TAGGED AT ANOTHER CAMERA IN THAT
PROJECT. This means that if the project did not record any Black
Panthers you will not see an absence or ‘0’ for black panthers in the
data.</em></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emu_pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/in_schema.html" class="external-link">in_schema</a></span><span class="op">(</span><span class="st">"camtrap"</span>, <span class="st">"processed_site_substation_presence_absence"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">common_name</span> <span class="op">==</span> <span class="st">"Emu"</span> <span class="op">&amp;</span> <span class="va">ProjectShortName</span> <span class="op">==</span> <span class="st">"StatewideDeer"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># use collect if you want to collect the above</span></span>
<span></span>
<span><span class="co"># you can also join this presence absence data to the operations data (which contains lat/longs)</span></span>
<span><span class="co"># joining can be done lazily (server side): But have to remove SubStation Column before joining as it is all NAs</span></span>
<span><span class="va">emu_pa_op</span> <span class="op">&lt;-</span> <span class="va">emu_pa</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">SubStation</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">emu_operations_query</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="getting-detection-histories-for-occupancy-analysis">Getting detection histories for occupancy analysis<a class="anchor" aria-label="anchor" href="#getting-detection-histories-for-occupancy-analysis"></a>
</h3>
<p>weda also has a function to pull down data for a project and species
for occupancy analysis using <code>unmarked</code> or <code>ubms</code>.
This allows you to get the detection histories of a species in a project
with one function (<code><a href="../reference/DBdetectionHistory.html">DBdetectionHistory()</a></code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get emu data for each site</span></span>
<span><span class="va">EmuDH</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DBdetectionHistory.html">DBdetectionHistory</a></span><span class="op">(</span><span class="va">con</span>,</span>
<span>                            ProjectShortName <span class="op">=</span> <span class="st">"StatewideDeer"</span>, <span class="co">#proj name</span></span>
<span>                            Species <span class="op">=</span> <span class="st">"Emu"</span>, <span class="co">#species</span></span>
<span>                            Iteration <span class="op">=</span> <span class="fl">1</span>, <span class="co">#iteration</span></span>
<span>                            byCamera <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">#no substrations</span></span>
<span>                            occasionStartTime <span class="op">=</span> <span class="fl">0</span>, <span class="co">#start at midnight</span></span>
<span>                            occasionLength <span class="op">=</span> <span class="fl">1</span>, <span class="co">#daily PA</span></span>
<span>                            includeEffort <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                            scaleEffort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co">#fractional deployment</span></span></code></pre></div>
<p>This then allows for an easy integration with unmarked or ubms for
occupancy analysis:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load the unmarked package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://groups.google.com/d/forum/unmarked" class="external-link">unmarked</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make the unmarked frame</span></span>
<span><span class="co"># Note the site covariates are nothing of interest here it is just </span></span>
<span><span class="co"># the presence_absence table with the lat/longs</span></span>
<span><span class="co"># Using the lat/longs you could extract more informative predictors from rasters or shapefiles</span></span>
<span><span class="va">umf</span> <span class="op">&lt;-</span> <span class="fu">unmarkedFrameOccu</span><span class="op">(</span>y <span class="op">=</span> <span class="va">EmuDH</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, </span>
<span>              siteCovs <span class="op">=</span> <span class="va">emu_pa_op</span><span class="op">)</span></span>
<span></span>
<span><span class="va">emu_occu</span> <span class="op">&lt;-</span> <span class="fu">occu</span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">umf</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">emu_occu</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Justin Cally.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
